# Copyright Â© 2023, Breu, Inc. <info@breu.io>. All rights reserved. 
#
# This software is made available by Breu, Inc., under the terms of the BREU COMMUNITY LICENSE AGREEMENT, Version 1.0, found at https://www.breu.io/license/community. BY INSTALLING, DOWNLOADING, ACCESSING, USING OR DISTRIBUTING ANY OF THE SOFTWARE, YOU AGREE TO THE TERMS OF THE LICENSE AGREEMENT. 
#
# The above copyright notice and the subsequent license agreement shall be included in all copies or substantial portions of the software. 
#
# Breu, Inc. HEREBY DISCLAIMS ANY AND ALL WARRANTIES AND CONDITIONS, EXPRESS, IMPLIED, STATUTORY, OR OTHERWISE, AND SPECIFICALLY DISCLAIMS ANY WARRANTY OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, WITH RESPECT TO THE SOFTWARE. 
#
# Breu, Inc. SHALL NOT BE LIABLE FOR ANY DAMAGES OF ANY KIND, INCLUDING BUT NOT LIMITED TO, LOST PROFITS OR ANY CONSEQUENTIAL, SPECIAL, INCIDENTAL, INDIRECT, OR DIRECT DAMAGES, HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, ARISING OUT OF THIS AGREEMENT. THE FOREGOING SHALL APPLY TO THE EXTENT PERMITTED BY APPLICABLE LAW. 
@startuml GitOps

participant "Workflow::PR" as pr #DC674E
participant "func::OnPRSignal" as spr
participant "Workflow::GetAsset" as ga #D0F090
participant "func::onGetAssetsSignal" as sga
participant "Workflow::ProvisionInfra" as pi #99FF99
participant "func::onInfraProvisionedSignal" as sip
participant "Workflow::Deployment" as d #99FF99
participant "Workflow::Mutex" as mw
participant "func::onDeploymentCompleteSignal" as sdc


pr -> mw: start child workflow
note over pr: waiting for signals

pr-> spr: handle signal (stackID, deploymentMap)
spr->spr: receive signal payload(PR ID)
spr->spr: create and save deploymentData
spr->ga: execute child workflow(stackID, PR ID)
spr->spr: update deployment state to gettingAssets
spr -> pr: return
note over pr: waiting for signals

ga-> ga: get resources, blueprint, \nworkloads and repos from DB
ga->ga: create and save changeset
ga->pr: signal external workflow(assets)

pr->sga: handle signal(stackID, deploymentData)
sga->sga: receive signal data(assets)
sga->pi: execute child workflow
sga->sga: update deployment state to ProvisioningInfra
sga->pr :return
note over pr: waiting for signals

loop resources 
    pi -> pi: create resource in activity
    end
pi->pr: signal external workflow(assets)

pr->sip: handle signal(stackID, deploymentMap)
sip-> sip: receive signal data(assets)
sip->d: execute child workflow
sip->sip: update deployment state to CreatingDeployment
sip->pr: return
note over pr: waiting for signals

d-> mw: request lock
mw->d: lock acquired
d->d: deploy
d->pr: signal external workflow(assets)

pr->sdc: handle signal








@enduml

